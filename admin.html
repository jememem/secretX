<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FanClub Admin: Tycoon V4.4 (Viral Update)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        .admin-scroll::-webkit-scrollbar { width: 4px; }
        .admin-scroll::-webkit-scrollbar-track { background: #09090b; }
        .admin-scroll::-webkit-scrollbar-thumb { background: #27272a; border-radius: 4px; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        .animate-pulse-red { animation: pulse-red 2s infinite; }

        .crt-overlay {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ffffff; cursor: pointer; margin-top: -6px; box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #27272a; border-radius: 2px; }
        
        .panel-header { @apply flex justify-between items-center border-b border-zinc-800 pb-3 mb-4; }
        .panel-title { @apply font-bold text-white text-sm flex items-center gap-2; }
        .hashtag-btn.selected { @apply border-indigo-500 bg-indigo-900/20 text-indigo-400; }
        
        .shop-item { @apply bg-zinc-900 border border-zinc-800 p-3 rounded hover:border-zinc-600 transition flex justify-between items-center; }
        .shop-item.owned { @apply border-green-900 bg-green-950/10 opacity-75; }

        .filter-btn { @apply text-[10px] bg-zinc-800 hover:bg-zinc-700 text-zinc-400 px-3 py-1 rounded border border-zinc-700 transition; }
        .filter-btn.active { @apply bg-indigo-600 text-white border-indigo-500; }
    </style>
</head>
<body class="bg-black text-zinc-300 h-screen overflow-hidden flex flex-col relative selection:bg-indigo-500 selection:text-white">

    <div class="crt-overlay absolute inset-0 z-50 opacity-20 pointer-events-none"></div>

    <!-- TOP BAR -->
    <div class="h-14 border-b border-zinc-800 bg-zinc-950 flex items-center justify-between px-6 z-40">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded flex items-center justify-center font-black text-white italic shadow-lg shadow-indigo-900/20">FC</div>
            <span class="font-bold text-white tracking-tight">ADMIN<span class="text-indigo-500">OS</span>_V4.4</span>
        </div>
        <div class="flex items-center gap-6 text-xs font-mono">
            <div class="flex items-center gap-2">
                <span class="text-zinc-500">REGION:</span>
                <span class="text-zinc-300">Global Node (US-East)</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-zinc-500">SYSTEM HEALTH:</span>
                <span id="server-status-text" class="text-emerald-400 font-bold">100%</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-zinc-500">DATE:</span>
                <span id="date-display" class="text-white">Day 1</span>
            </div>
        </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="flex-1 flex overflow-hidden z-40">
        
        <!-- SIDEBAR -->
        <div class="w-80 bg-zinc-950 border-r border-zinc-800 flex flex-col justify-between p-4 overflow-y-auto admin-scroll">
            <div class="space-y-4">
                
                <!-- Main Treasury -->
                <div class="p-4 bg-zinc-900 rounded-xl border border-zinc-800 relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                    <div class="text-[10px] text-zinc-500 uppercase font-bold mb-1">Treasury (USD)</div>
                    <div class="text-2xl font-mono text-white font-bold tracking-tighter" id="treasury-display">$50,000</div>
                    <div class="text-[10px] flex justify-between mt-2 font-mono">
                        <span id="daily-profit-display" class="text-zinc-400">+$0.00</span>
                        <span class="text-zinc-600">Last 24h</span>
                    </div>
                </div>

                <!-- Live Chart -->
                <div class="h-32 w-full bg-zinc-900 rounded border border-zinc-800 p-2">
                    <canvas id="moneyChart"></canvas>
                </div>

                <!-- Corporate Shop Button -->
                <button onclick="openShopModal()" class="w-full bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 text-white font-bold text-xs py-3 rounded flex items-center justify-between px-4 transition group">
                    <span class="flex items-center gap-2"><i data-lucide="shield-check" class="w-4 h-4 text-emerald-500"></i> Corporate Shop</span>
                    <i data-lucide="chevron-right" class="w-3 h-3 text-zinc-500 group-hover:text-white"></i>
                </button>

                <!-- Trending Strategy -->
                <div class="p-3 bg-zinc-900 rounded border border-zinc-800">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] text-zinc-500 uppercase font-bold">Trend Strategy</span>
                        <span id="trend-status" class="text-[9px] text-zinc-600">No active trend</span>
                    </div>
                    
                    <div class="flex gap-2 mb-1">
                        <input type="text" id="hashtag-input" class="w-full bg-zinc-950 border border-zinc-700 rounded p-2 text-xs text-white focus:border-indigo-500 focus:outline-none placeholder-zinc-600 font-mono" placeholder="#EnterTrend">
                        <button onclick="submitCustomHashtag()" class="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-white px-3 py-1 rounded transition">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="flex justify-between mt-2">
                        <p class="text-[9px] text-zinc-600">Impacts daily spend.</p>
                        <p class="text-[9px] text-indigo-400 font-mono" id="trend-days-left"></p>
                    </div>
                </div>

                <!-- Server Infrastructure -->
                <div class="bg-zinc-900 p-3 rounded border border-zinc-800">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] text-zinc-500 uppercase font-bold">Infrastructure</span>
                        <span id="server-cost-display" class="text-[10px] text-red-400 font-mono">-$22.50/day</span>
                    </div>
                    <div class="flex justify-between items-end mb-2">
                        <div class="text-xs font-mono text-white">
                            <span id="server-used-display" class="font-bold">1,200</span> / <span id="server-cap-display" class="text-zinc-500">5,000</span>
                        </div>
                        <div class="text-[9px] text-zinc-500">Load</div>
                    </div>
                    <div class="w-full bg-zinc-950 h-2 rounded-full overflow-hidden border border-zinc-800 relative">
                        <div id="server-load-bar" class="bg-blue-500 h-full w-[24%] transition-all duration-300"></div>
                    </div>
                    <div class="mt-2 flex justify-between items-center">
                        <span class="text-[9px] text-zinc-600">Maint: <span id="base-server-cost">$12.00</span></span>
                        <button onclick="upgradeServers()" id="btn-upgrade-server" class="text-[10px] bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-white px-2 py-1 rounded transition">
                            Upgrade (+$5k)
                        </button>
                    </div>
                </div>

                <!-- Event Log Overlay -->
                <div id="event-overlay" class="hidden fixed inset-0 bg-black/50 z-50 pointer-events-none flex items-center justify-center">
                    <div class="bg-zinc-900 border border-zinc-700 text-white p-6 rounded-xl shadow-2xl animate-bounce max-w-sm text-center">
                        <div class="mb-2 flex justify-center"><i data-lucide="alert-triangle" class="w-8 h-8 text-yellow-500"></i></div>
                        <h2 class="font-bold text-lg mb-1" id="event-title">EVENT</h2>
                        <p id="event-message" class="text-sm text-zinc-400">Message</p>
                    </div>
                </div>

                <!-- Process Day -->
                <button onclick="nextDay()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold text-sm py-4 rounded shadow-[0_0_20px_rgba(79,70,229,0.2)] transition active:scale-95 flex items-center justify-center gap-2 border border-indigo-500/50">
                    <i data-lucide="play" class="w-4 h-4"></i> RUN NEXT DAY
                </button>
            </div>
        </div>

        <!-- MAIN DASHBOARD -->
        <div class="flex-1 bg-black p-6 overflow-y-auto admin-scroll">
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                
                <!-- CREATOR OPS -->
                <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-5">
                    <div class="panel-header">
                        <h3 class="panel-title text-purple-400"><i data-lucide="users" class="w-4 h-4"></i> Creator Tax Policy</h3>
                        <span class="text-[10px] bg-zinc-800 px-2 py-1 rounded text-zinc-400">Avg Happiness: <span id="avg-happiness" class="text-white">100%</span></span>
                    </div>

                    <div class="space-y-3">
                        <!-- Oppressed Tax -->
                        <div class="bg-zinc-950 p-3 rounded border border-zinc-800/50">
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-zinc-400 flex items-center gap-2">
                                    Oppressed Tier 
                                    <span id="count-oppressed" class="text-[9px] text-zinc-600 bg-zinc-900 px-1.5 py-0.5 rounded border border-zinc-800">0</span>
                                </span>
                                <span class="text-zinc-200 font-mono font-bold" id="tax-oppressed-display">50%</span>
                            </div>
                            <input id="slider-oppressed" type="range" min="10" max="90" value="50" class="w-full h-2 bg-zinc-800 rounded-lg cursor-pointer" oninput="updateTax('oppressed', this.value)">
                            <div class="flex justify-between mt-1 pt-1 border-t border-zinc-900">
                                <span class="text-[9px] text-zinc-600">Risk: High</span>
                                <span class="text-[10px] text-emerald-500 font-mono" id="proj-oppressed">Est: $0/day</span>
                            </div>
                        </div>

                        <!-- Fighter Tax -->
                        <div class="bg-zinc-950 p-3 rounded border border-zinc-800/50">
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-purple-400 flex items-center gap-2">
                                    Fighter Tier
                                    <span id="count-fighter" class="text-[9px] text-purple-900/50 bg-purple-900/10 px-1.5 py-0.5 rounded border border-purple-900/20">0</span>
                                </span>
                                <span class="text-zinc-200 font-mono font-bold" id="tax-fighter-display">40%</span>
                            </div>
                            <input id="slider-fighter" type="range" min="10" max="80" value="40" class="w-full h-2 bg-zinc-800 rounded-lg cursor-pointer" oninput="updateTax('fighter', this.value)">
                            <div class="flex justify-between mt-1 pt-1 border-t border-zinc-900">
                                <span class="text-[9px] text-zinc-600">Risk: Med</span>
                                <span class="text-[10px] text-emerald-500 font-mono" id="proj-fighter">Est: $0/day</span>
                            </div>
                        </div>

                        <!-- Queen Tax -->
                        <div class="bg-zinc-950 p-3 rounded border border-zinc-800/50">
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-pink-500 flex items-center gap-2">
                                    Queen Tier
                                    <span id="count-queen" class="text-[9px] text-pink-900/50 bg-pink-900/10 px-1.5 py-0.5 rounded border border-pink-900/20">0</span>
                                </span>
                                <span class="text-zinc-200 font-mono font-bold" id="tax-queen-display">25%</span>
                            </div>
                            <input id="slider-queen" type="range" min="5" max="60" value="25" class="w-full h-2 bg-zinc-800 rounded-lg cursor-pointer" oninput="updateTax('queen', this.value)">
                            <div class="flex justify-between mt-1 pt-1 border-t border-zinc-900">
                                <span class="text-[9px] text-zinc-600">Risk: Low</span>
                                <span class="text-[10px] text-emerald-500 font-mono" id="proj-queen">Est: $0/day</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AUDIENCE GROWTH -->
                <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-5">
                    <div class="panel-header">
                        <h3 class="panel-title text-blue-400"><i data-lucide="globe" class="w-4 h-4"></i> Audience Operations</h3>
                        <span class="text-[10px] bg-zinc-800 px-2 py-1 rounded text-zinc-400">Total Fans: <span id="fan-count" class="text-white">0</span></span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- Join Fee -->
                        <div class="bg-zinc-950 p-3 rounded border border-zinc-800 col-span-2 sm:col-span-1">
                            <div class="flex justify-between text-xs mb-2">
                                <span class="font-bold text-zinc-400">Join Fee</span>
                                <span id="join-fee-display" class="text-white font-mono">$0</span>
                            </div>
                            <input type="range" min="0" max="50" step="1" value="0" class="w-full h-2 bg-zinc-800 rounded-lg cursor-pointer" oninput="updateJoinFee(this.value)">
                            <p class="text-[9px] text-zinc-500 mt-1">One-time fee for new fans.</p>
                        </div>

                        <!-- Fan Subscription -->
                        <div class="bg-zinc-950 p-3 rounded border border-zinc-800 col-span-2 sm:col-span-1 flex flex-col justify-between">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-zinc-400 text-xs">Fan Sub</span>
                                <div onclick="toggleFanSub()" id="sub-toggle" class="w-8 h-4 bg-zinc-700 rounded-full cursor-pointer relative transition-colors">
                                    <div id="sub-knob" class="absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full transition-all"></div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-[9px] text-zinc-500">Price/Mo</span>
                                <span id="fan-sub-price-display" class="text-white font-mono text-xs">$0</span>
                            </div>
                            <input type="range" min="0" max="100" step="5" value="0" class="w-full h-2 bg-zinc-800 rounded-lg cursor-pointer mt-1" oninput="updateFanSubPrice(this.value)">
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div class="text-[10px] text-zinc-500 uppercase font-bold">Marketing Campaigns</div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="runCampaign('uni')" id="btn-uni" class="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 p-2 rounded text-left transition group">
                                <div class="text-xs font-bold text-white group-hover:text-emerald-400">Uni Blitz</div>
                                <div class="text-[10px] text-zinc-500">Cost: $2,000</div>
                            </button>
                            <button onclick="runCampaign('gov')" id="btn-gov" class="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 p-2 rounded text-left transition group">
                                <div class="text-xs font-bold text-white group-hover:text-blue-400">Gov Arts Grant</div>
                                <div class="text-[10px] text-zinc-500">Cost: $50,000</div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- LEADERBOARD -->
                <div class="col-span-1 xl:col-span-2 bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden">
                    <div class="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950/50">
                        <h3 class="font-bold text-white text-sm flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4 text-emerald-500"></i> Creator Stats</h3>
                        <div class="flex gap-2">
                            <button onclick="setFilter('top10')" id="filter-top10" class="filter-btn">Top 10</button>
                            <button onclick="setFilter('top20')" id="filter-top20" class="filter-btn">Top 20</button>
                            <button onclick="setFilter('top50')" id="filter-top50" class="filter-btn">Top 50</button>
                            <button onclick="setFilter('all')" id="filter-all" class="filter-btn active">All</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[400px] admin-scroll">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-zinc-950 text-zinc-500 border-b border-zinc-800 uppercase tracking-wider sticky top-0">
                                <tr>
                                    <th class="p-3 w-10">#</th>
                                    <th class="p-3">Handle</th>
                                    <th class="p-3">Tier</th>
                                    <th class="p-3">Fans</th>
                                    <th class="p-3 text-right">Creator Net</th>
                                    <th class="p-3 text-right">Platform Tax</th>
                                </tr>
                            </thead>
                            <tbody id="creator-table-body" class="divide-y divide-zinc-800 text-zinc-300 font-mono">
                                <!-- JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- CORPORATE SHOP MODAL -->
    <div id="shop-modal" class="hidden fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4">
        <div class="bg-zinc-900 border border-zinc-700 p-6 rounded-xl max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="shield-check" class="text-emerald-500"></i> Corporate Services</h3>
                <button onclick="closeShopModal()" class="text-zinc-500 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            
            <div class="space-y-3">
                <div id="item-lawyer" class="shop-item">
                    <div>
                        <div class="font-bold text-white text-sm">Legal Team Retainer</div>
                        <div class="text-[10px] text-zinc-400">Blocks Lawsuits</div>
                    </div>
                    <button onclick="buyUpgrade('lawyer', 20000)" class="bg-zinc-800 hover:bg-emerald-600 text-white text-xs px-3 py-1.5 rounded font-bold transition">$20,000</button>
                </div>
                <div id="item-encryption" class="shop-item">
                    <div>
                        <div class="font-bold text-white text-sm">Adv. Data Encryption</div>
                        <div class="text-[10px] text-zinc-400">Blocks Data Breaches</div>
                    </div>
                    <button onclick="buyUpgrade('encryption', 15000)" class="bg-zinc-800 hover:bg-emerald-600 text-white text-xs px-3 py-1.5 rounded font-bold transition">$15,000</button>
                </div>
                <div id="item-ddos" class="shop-item">
                    <div>
                        <div class="font-bold text-white text-sm">DDoS Mitigation Shield</div>
                        <div class="text-[10px] text-zinc-400">Prevents Server Attacks</div>
                    </div>
                    <button onclick="buyUpgrade('ddos', 8000)" class="bg-zinc-800 hover:bg-emerald-600 text-white text-xs px-3 py-1.5 rounded font-bold transition">$8,000</button>
                </div>
                <div id="item-offshore" class="shop-item">
                    <div>
                        <div class="font-bold text-white text-sm">Offshore Banking</div>
                        <div class="text-[10px] text-zinc-400">Prevents Payment Freezes</div>
                    </div>
                    <button onclick="buyUpgrade('offshore', 25000)" class="bg-zinc-800 hover:bg-emerald-600 text-white text-xs px-3 py-1.5 rounded font-bold transition">$25,000</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GAME OVER MODAL -->
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
        <div class="text-center p-8 border border-red-900 rounded-xl bg-zinc-950">
            <h1 class="text-6xl font-black text-red-600 mb-4 tracking-tighter">BANKRUPT</h1>
            <p class="text-zinc-400 mb-8">The platform is insolvent.</p>
            <button onclick="location.reload()" class="bg-white text-black px-8 py-3 rounded font-bold uppercase hover:bg-zinc-200">Restart Server</button>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let state = {
            day: 1,
            money: 50000,
            taxes: { Oppressed: 0.50, Fighter: 0.40, Queen: 0.25 },
            joinFee: 0,
            fanSubEnabled: false,
            fanSubPrice: 0,
            serverCapacity: 20000,
            totalFans: 15000,
            creators: [],
            history: { money: [50000], labels: ['Start'] },
            campaigns: { uni: 0, gov: 0 },
            activeHashtag: null,
            hashtagDaysLeft: 0,
            upgrades: { lawyer: false, encryption: false, ddos: false, offshore: false },
            filter: 'all'
        };

        let chartInstance = null;

        // --- HELPER FUNCTIONS ---
        function setText(id, text) {
            const el = document.getElementById(id);
            if(el) el.innerText = text;
        }

        // --- INIT ---
        function init() {
            // Generate 100 initial creators
            for(let i=0; i<100; i++) {
                createRandomCreator();
            }
            initChart();
            lucide.createIcons();
            
            // Sync slider UI
            const opSlider = document.getElementById('slider-oppressed');
            const fiSlider = document.getElementById('slider-fighter');
            const quSlider = document.getElementById('slider-queen');
            
            if(opSlider) opSlider.value = state.taxes.Oppressed * 100;
            if(fiSlider) fiSlider.value = state.taxes.Fighter * 100;
            if(quSlider) quSlider.value = state.taxes.Queen * 100;
            
            updateUI();
            
            updateTax('oppressed', 50);
            updateTax('fighter', 40);
            updateTax('queen', 25);
        }

        function createRandomCreator() {
            const roll = Math.random();
            let tier = "Oppressed";
            if (roll > 0.95) tier = "Queen";
            else if (roll > 0.80) tier = "Fighter";

            let subs = 0;
            if(tier === "Queen") subs = 5000 + Math.floor(Math.random() * 5000);
            else if(tier === "Fighter") subs = 500 + Math.floor(Math.random() * 2000);
            else subs = Math.floor(Math.random() * 400);

            const randomNum = Math.floor(10000000 + Math.random() * 90000000);
            const handle = `@user_${randomNum}`;

            state.creators.push({
                id: Math.random().toString(36).substr(2, 9),
                handle: handle,
                tier: tier,
                subscribers: subs,
                happiness: 70 + Math.floor(Math.random() * 30),
                dailyEarnings: 0
            });
        }

        function initChart() {
            const ctx = document.getElementById('moneyChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: state.history.labels,
                    datasets: [{
                        label: 'Treasury',
                        data: state.history.money,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        }

        // --- ACTIONS ---
        function setFilter(filter) {
            state.filter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`filter-${filter}`).classList.add('active');
            updateUI();
        }

        function updateTax(tier, val) {
            const key = tier.charAt(0).toUpperCase() + tier.slice(1);
            state.taxes[key] = val / 100;
            setText(`tax-${tier}-display`, val + "%");
            
            // Projection
            let projected = 0;
            state.creators.forEach(c => {
                if(c.tier === key) {
                    const gross = c.subscribers * 0.15; 
                    projected += gross * (val / 100);
                }
            });
            setText(`proj-${tier}`, `Est: $${projected.toFixed(2)}/day`);
        }

        function updateJoinFee(val) {
            state.joinFee = parseInt(val);
            setText('join-fee-display', "$" + val);
        }

        // --- NEW: Fan Subscription Logic ---
        function updateFanSubPrice(val) {
            state.fanSubPrice = parseInt(val);
            setText('fan-sub-price-display', "$" + val + "/mo");
        }

        function toggleFanSub() {
            state.fanSubEnabled = !state.fanSubEnabled;
            const toggle = document.getElementById('sub-toggle');
            const knob = document.getElementById('sub-knob');
            
            if(state.fanSubEnabled) {
                toggle.className = "w-8 h-4 bg-green-500 rounded-full cursor-pointer relative transition-colors";
                knob.className = "absolute top-0.5 right-0.5 w-3 h-3 bg-white rounded-full transition-all";
            } else {
                toggle.className = "w-8 h-4 bg-zinc-700 rounded-full cursor-pointer relative transition-colors";
                knob.className = "absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full transition-all";
            }
        }

        // --- Unchanged Ad Logic ---
        function toggleAds() {
            state.adsEnabled = !state.adsEnabled;
            const toggle = document.getElementById('ad-toggle');
            const knob = document.getElementById('ad-knob');
            
            if(state.adsEnabled) {
                toggle.className = "w-8 h-4 bg-green-500 rounded-full cursor-pointer relative transition-colors";
                knob.className = "absolute top-0.5 right-0.5 w-3 h-3 bg-white rounded-full transition-all";
            } else {
                toggle.className = "w-8 h-4 bg-zinc-700 rounded-full cursor-pointer relative transition-colors";
                knob.className = "absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full transition-all";
            }
        }

        function submitCustomHashtag() {
            const input = document.getElementById('hashtag-input');
            const tag = input.value.trim();
            if(!tag) return;
            
            const formatted = tag.startsWith('#') ? tag : '#' + tag;
            state.activeHashtag = formatted;
            state.hashtagDaysLeft = 30; // Lasts 30 days
            
            const status = document.getElementById('trend-status');
            if(status) {
                status.innerText = `Active: ${formatted}`;
                status.className = "text-[9px] text-emerald-400 font-bold";
            }
            
            input.value = "";
            alert(`Trend set: ${formatted}. Active for 30 days.`);
            updateUI();
        }

        function runCampaign(type) {
            if(type === 'uni') {
                if(state.money < 2000) return alert("Insufficient funds!");
                state.money -= 2000;
                state.campaigns.uni = 3;
            }
            if(type === 'gov') {
                if(state.money < 50000) return alert("Insufficient funds!");
                state.money -= 50000;
                state.campaigns.gov = 1; // Instant effect usually
                // Trigger massive influx immediately
                for(let i=0; i<200; i++) createRandomCreator();
                alert("Government Grant Approved! 200+ Creators Onboarded.");
            }
            updateUI();
        }

        function upgradeServers() {
            if(state.money < 5000) return alert("Insufficient funds!");
            state.money -= 5000;
            state.serverCapacity += 5000;
            updateUI();
        }

        // --- SHOP & UPGRADES ---
        function openShopModal() { document.getElementById('shop-modal').classList.remove('hidden'); }
        function closeShopModal() { document.getElementById('shop-modal').classList.add('hidden'); }

        function buyUpgrade(type, cost) {
            if(state.money < cost) return alert("Insufficient funds!");
            state.money -= cost;
            state.upgrades[type] = true;
            
            const item = document.getElementById(`item-${type}`);
            if(item) {
                item.classList.add('owned');
                const btn = item.querySelector('button');
                btn.innerText = "Active";
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            updateUI();
        }

        function showEventOverlay(title, msg, color="red") {
            const el = document.getElementById('event-overlay');
            const tEl = document.getElementById('event-title');
            const mEl = document.getElementById('event-message');
            
            tEl.innerText = title;
            mEl.innerText = msg;
            
            if(color === "green") {
                el.querySelector('div').className = "bg-green-900 border border-green-500 text-green-200 p-6 rounded-xl shadow-2xl animate-bounce max-w-sm text-center";
                tEl.innerHTML = `<i data-lucide="shield-check" class="inline w-6 h-6 mr-1"></i> ${title}`;
            } else {
                el.querySelector('div').className = "bg-red-950 border border-red-500 text-red-200 p-6 rounded-xl shadow-2xl animate-bounce max-w-sm text-center";
                tEl.innerHTML = `<i data-lucide="alert-triangle" class="inline w-6 h-6 mr-1"></i> ${title}`;
            }
            
            el.classList.remove('hidden');
            lucide.createIcons();
            setTimeout(() => {
                el.classList.add('hidden');
            }, 3000);
        }

        // --- GAME LOOP ---
        function nextDay() {
            // 1. Hashtag Impact (Long Term)
            let hashtagMultiplier = 1.0;
            let hashtagSpendBoost = 0;
            
            if(state.activeHashtag && state.hashtagDaysLeft > 0) {
                state.hashtagDaysLeft--;
                // Daily variance of trend power
                const reaction = Math.random(); 
                if(reaction > 0.6) {
                    hashtagMultiplier = 1.2;
                    hashtagSpendBoost = 0.05;
                } else if (reaction < 0.2) {
                    hashtagMultiplier = 0.9;
                    hashtagSpendBoost = -0.01;
                }
            } else if (state.activeHashtag && state.hashtagDaysLeft <= 0) {
                state.activeHashtag = null;
                setText('trend-status', 'Trend Expired');
                document.getElementById('trend-status').className = "text-[9px] text-zinc-600";
            }

            // 2. Growth Calculation
            let growthMultiplier = 1.0 * hashtagMultiplier;
            let churnMultiplier = 1.0;

            if(state.joinFee > 0) growthMultiplier -= (state.joinFee * 0.02);
            
            // Ads Churn Logic (Ads annoy users)
            // Fan Sub Churn Logic (Subs annoy users more depending on price)
            if(state.adsEnabled) churnMultiplier += 0.10;
            if(state.fanSubEnabled) {
                // $10/mo adds 5% churn, $100/mo adds 50% churn
                churnMultiplier += (state.fanSubPrice / 200); 
            }

            let organicBase = Math.floor(Math.random() * 100) + 20; 
            
            if(state.campaigns.uni > 0) { organicBase += 500; state.campaigns.uni--; }

            let actualNewFans = Math.floor(organicBase * Math.max(0.1, growthMultiplier));
            
            // New Creator Chance
            if(Math.random() > 0.8 || state.campaigns.uni > 0) createRandomCreator();

            // 3. Financials
            let dailyPlatformRevenue = 0;
            
            // A. Join Fees
            dailyPlatformRevenue += (actualNewFans * state.joinFee);
            
            // B. Ad Revenue (if enabled)
            if(state.adsEnabled) dailyPlatformRevenue += (state.totalFans * 0.02); // $0.02 per user

            // C. Fan Subscription Revenue (if enabled)
            if(state.fanSubEnabled) {
                // Not all fans pay, some might just churn out immediately
                // Simple model: Revenue = Total Fans * (Price / 30 days)
                const dailySubRev = state.totalFans * (state.fanSubPrice / 30);
                dailyPlatformRevenue += dailySubRev;
            }

            state.totalFans += actualNewFans;

            // 4. Creator Sim & Fan Spend
            let dailyFanSpend = 0.10 + (Math.random() * 0.15) + hashtagSpendBoost;
            dailyFanSpend = Math.max(0.01, dailyFanSpend);

            state.creators.forEach(c => {
                const taxRate = state.taxes[c.tier];
                
                // Hustle Bonus
                let hustleBonus = 1.0;
                if(c.tier !== "Queen" && taxRate > 0.30) hustleBonus = 1.0 + (taxRate - 0.30); 

                // Happiness
                if(taxRate > 0.40) c.happiness -= 2;
                else if(taxRate < 0.25) c.happiness += 1;

                // Growth
                const baseGrowth = Math.floor((c.subscribers * 0.005) * (c.happiness/100));
                const fanShare = Math.floor(actualNewFans / state.creators.length);
                
                // Discovery from existing fans (The Fix for 8k cap)
                // 0.1% of ALL existing fans find this creator today
                const discoveryGrowth = Math.floor(state.totalFans * 0.001 * (c.happiness/100));

                // Churn impacted by platform annoyances
                let churnRate = 0.005; 
                if(state.adsEnabled) churnRate += 0.01;
                if(state.fanSubEnabled) churnRate += (state.fanSubPrice / 500); // More expensive = more churn
                if(c.tier === "Queen") churnRate = 0.001; // Queens are sticky

                const subsLost = Math.floor(c.subscribers * churnRate);
                
                // Viral Logic
                let viralBonus = 1.0;
                if(Math.random() > 0.98) viralBonus = 5.0; // 2% chance for massive day

                const subsGained = Math.floor((baseGrowth + fanShare + discoveryGrowth) * hustleBonus * viralBonus);
                
                c.subscribers = Math.max(0, c.subscribers + subsGained - subsLost);

                // Financials (Tips/Content Sales)
                const gross = c.subscribers * dailyFanSpend;
                const tax = gross * taxRate;
                const net = gross - tax;

                dailyPlatformRevenue += tax;
                c.dailyEarnings = net; 
                
                if(c.dailyEarnings > 500) c.happiness += 1;
                c.happiness = Math.max(0, Math.min(100, c.happiness));

                // Tier Logic
                if(c.tier === "Oppressed" && c.subscribers > 500) c.tier = "Fighter";
                if(c.tier === "Fighter" && c.subscribers > 5000) c.tier = "Queen";
                if(c.tier === "Fighter" && c.subscribers < 400) c.tier = "Oppressed";
                if(c.tier === "Queen" && c.subscribers < 4000) c.tier = "Fighter";
            });

            // 5. Server Economics
            const totalUsers = state.totalFans + state.creators.length;
            const serverLoad = totalUsers / state.serverCapacity;
            
            const baseMaintenance = state.serverCapacity * 0.005; 
            const bandwidthCost = totalUsers * 0.01; 
            let totalServerCost = baseMaintenance + bandwidthCost;

            if(serverLoad > 1.0) {
                dailyPlatformRevenue = 0; 
                totalServerCost *= 2; 
                showEventOverlay("SERVER CRASH", "0 Revenue generated today.");
            }

            // 6. NEGATIVE FINANCIAL EVENTS
            if(Math.random() > 0.98) {
                if(state.upgrades.lawyer) {
                    showEventOverlay("CRISIS AVERTED", "Legal Team blocked a lawsuit.", "green");
                } else {
                    const fine = 15000;
                    state.money -= fine;
                    showEventOverlay("LAWSUIT FILED", `Paid -$${fine.toLocaleString()} in fees.`);
                }
            }
            else if(Math.random() > 0.98) {
                if(state.upgrades.encryption) {
                    showEventOverlay("ATTACK BLOCKED", "Encryption stopped a data breach.", "green");
                } else {
                    const fine = 8000;
                    state.money -= fine;
                    showEventOverlay("DATA BREACH", `FTC Fine: -$${fine.toLocaleString()}`);
                }
            }
            else if(Math.random() > 0.98) {
                if(state.upgrades.ddos) {
                    showEventOverlay("DDoS MITIGATED", "Traffic scrubbed successfully.", "green");
                } else {
                    const cost = 2500;
                    state.money -= cost;
                    dailyPlatformRevenue = 0; 
                    showEventOverlay("DDoS ATTACK", `System Offline. Cost: -$${cost.toLocaleString()}`);
                }
            }
            else if(Math.random() > 0.97) {
                if(state.upgrades.offshore) {
                    showEventOverlay("FUNDS SECURE", "Offshore accounts bypassed freeze.", "green");
                } else {
                    const freeze = state.money * 0.10;
                    if(freeze > 0) {
                        state.money -= freeze;
                        showEventOverlay("PAYMENT FREEZE", `Lost -$${freeze.toFixed(0)} to hold.`);
                    }
                }
            }

            const dailyProfit = dailyPlatformRevenue - totalServerCost;
            state.money += dailyProfit;
            state.day++;

            // Chart
            state.history.money.push(state.money);
            state.history.labels.push(`D${state.day}`);
            if(state.history.money.length > 20) {
                state.history.money.shift();
                state.history.labels.shift();
            }

            const gameOverModal = document.getElementById('game-over-modal');
            if(state.money < 0 && gameOverModal) {
                gameOverModal.classList.remove('hidden');
            }

            updateUI();
            
            // Recalculate UI Projections
            updateTax('oppressed', state.taxes.Oppressed * 100);
            updateTax('fighter', state.taxes.Fighter * 100);
            updateTax('queen', state.taxes.Queen * 100);
        }

        // --- UI UPDATES ---
        function updateUI() {
            setText('date-display', `Day ${state.day}`);
            setText('treasury-display', `$${Math.floor(state.money).toLocaleString()}`);
            
            const lastProfit = state.history.money[state.history.money.length-1] - state.history.money[state.history.money.length-2] || 0;
            const profEl = document.getElementById('daily-profit-display');
            if(profEl) {
                profEl.innerText = (lastProfit >= 0 ? "+" : "") + `$${lastProfit.toFixed(2)}`;
                profEl.className = lastProfit >= 0 ? "text-emerald-400" : "text-red-400";
            }

            setText('creator-count', state.creators.length);
            setText('fan-count', state.totalFans.toLocaleString());

            const avgHapp = state.creators.length > 0 
                ? Math.floor(state.creators.reduce((a,b)=>a+b.happiness,0)/state.creators.length) 
                : 0;
            setText('avg-happiness', avgHapp + "%");
            
            // Server Stats
            const totalUsers = state.totalFans + state.creators.length;
            const load = (totalUsers / state.serverCapacity) * 100;
            
            const projMaint = state.serverCapacity * 0.005;
            const projBand = totalUsers * 0.01;
            setText('server-cost-display', `-$${(projMaint+projBand).toFixed(2)}/day`);
            setText('server-used-display', totalUsers.toLocaleString());
            setText('server-cap-display', state.serverCapacity.toLocaleString());
            
            const sBar = document.getElementById('server-load-bar');
            if(sBar) {
                sBar.style.width = `${Math.min(100, load)}%`;
                sBar.className = load > 90 ? "bg-red-500 h-full animate-pulse" : "bg-blue-500 h-full";
            }

            const sText = document.getElementById('server-status-text');
            if(sText) {
                sText.innerText = load.toFixed(1) + "%";
                sText.className = load > 90 ? "text-red-500 animate-pulse font-bold" : "text-emerald-400 font-bold";
            }
            
            setText('base-server-cost', `$${projMaint.toFixed(2)}`);

            // Trend UI
            const trendDays = document.getElementById('trend-days-left');
            if(trendDays && state.activeHashtag) {
                trendDays.innerText = `${state.hashtagDaysLeft}d left`;
            } else if (trendDays) {
                trendDays.innerText = "";
            }

            if(chartInstance) {
                chartInstance.data.labels = state.history.labels;
                chartInstance.data.datasets[0].data = state.history.money;
                chartInstance.update();
            }

            let counts = { Oppressed: 0, Fighter: 0, Queen: 0 };
            let totalRevenue = 0;
            
            const tbody = document.getElementById('creator-table-body');
            if(tbody) {
                tbody.innerHTML = "";
                let sorted = [...state.creators].sort((a,b) => b.dailyEarnings - a.dailyEarnings);
                
                // FILTER LOGIC
                if(state.filter === 'top10') sorted = sorted.slice(0, 10);
                else if(state.filter === 'top20') sorted = sorted.slice(0, 20);
                else if(state.filter === 'top50') sorted = sorted.slice(0, 50);
                
                // Global Count
                state.creators.forEach(c => { if(counts[c.tier] !== undefined) counts[c.tier]++; });

                sorted.forEach((c, idx) => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-zinc-900 transition border-b border-zinc-900";
                    
                    let tierClass = "text-zinc-400";
                    if(c.tier === "Fighter") tierClass = "text-purple-400";
                    if(c.tier === "Queen") tierClass = "text-pink-500";

                    const taxRate = state.taxes[c.tier];
                    const gross = c.dailyEarnings / (1 - taxRate);
                    const cut = gross * taxRate;
                    totalRevenue += cut;

                    tr.innerHTML = `
                        <td class="p-3 text-zinc-500">#${idx+1}</td>
                        <td class="p-3 font-bold text-white">${c.handle}</td>
                        <td class="p-3 font-bold ${tierClass}">${c.tier}</td>
                        <td class="p-3 text-zinc-400">${c.subscribers.toLocaleString()}</td>
                        <td class="p-3 text-right text-green-400">$${c.dailyEarnings.toFixed(2)}</td>
                        <td class="p-3 text-right text-emerald-600">+$${cut.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            setText('count-oppressed', counts.Oppressed);
            setText('count-fighter', counts.Fighter);
            setText('count-queen', counts.Queen);
            setText('total-revenue-display', `+$${totalRevenue.toFixed(2)}`);

            lucide.createIcons();
        }

        window.onload = init;
    </script>
</body>
</html>
