<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Sim - Fixed & Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; }

        /* Custom Scrollbar */
        .log-scroll::-webkit-scrollbar { width: 4px; }
        .log-scroll::-webkit-scrollbar-track { background: #18181b; }
        .log-scroll::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .scan-line {
            width: 100%; height: 2px; background: #10b981;
            position: absolute; top: 0; left: 0;
            animation: scan 1.5s infinite linear;
            box-shadow: 0 0 10px #10b981;
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .vibe-option.selected { border-color: #ec4899; background-color: #500724; ring: 1px solid #ec4899; }
        .vibe-option.disabled-option { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        
        .agency-card.selected { border-color: #a855f7; background-color: #3b0764; }
        
        .age-btn.selected { background-color: #0f172a; border-color: #38bdf8; color: #38bdf8; }

        /* Phone Screen */
        .phone-screen { background: #000; box-shadow: inset 0 0 20px rgba(255,255,255,0.05); }
        .glass-panel { background: rgba(24, 24, 27, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* Carousel */
        .carousel-track { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; }
        .carousel-item { flex: 0 0 100%; scroll-snap-align: start; }
        .carousel-track::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden">

    <!-- REGISTRATION SCREEN -->
    <div id="registration-screen" class="fixed inset-0 bg-zinc-950 z-[100] flex flex-col items-center justify-center p-4 overflow-y-auto">
        <div class="bg-zinc-900 p-8 rounded-xl shadow-2xl max-w-lg w-full border border-zinc-800 my-auto relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-pink-500 to-violet-600"></div>
            <h1 class="text-2xl font-bold text-center mb-1 text-white tracking-tight">CREATOR ID SETUP</h1>
            <p class="text-center text-zinc-500 text-xs mb-8 uppercase tracking-widest">Platform Registration</p>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-semibold text-zinc-400 mb-1 uppercase">Handle</label>
                    <div class="flex items-center">
                        <span class="bg-zinc-800 p-3 rounded-l border-y border-l border-zinc-700 text-zinc-400">@</span>
                        <input type="text" id="reg-handle" class="w-full bg-zinc-900 border border-zinc-700 rounded-r p-3 text-white focus:outline-none focus:border-pink-500 transition-colors" placeholder="creator_name">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-zinc-400 mb-2 uppercase">Age Group</label>
                        <div class="flex flex-col gap-2" id="age-selection">
                            <button onclick="selectAge('18-19')" id="age-18-19" class="age-btn w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-xs text-zinc-400 hover:bg-zinc-700 transition flex justify-between items-center">
                                <span>18-19</span> <span class="text-[10px] text-green-500 bg-green-500/10 px-1 rounded">High Bonus</span>
                            </button>
                            <button onclick="selectAge('20-24')" id="age-20-24" class="age-btn w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-xs text-zinc-400 hover:bg-zinc-700 transition flex justify-between items-center">
                                <span>20-24</span> <span class="text-[10px] text-yellow-500 bg-yellow-500/10 px-1 rounded">Med Bonus</span>
                            </button>
                            <button onclick="selectAge('25+')" id="age-25+" class="age-btn w-full bg-zinc-800 border border-zinc-700 rounded p-2 text-xs text-zinc-400 hover:bg-zinc-700 transition flex justify-between items-center">
                                <span>25+</span> <span class="text-[10px] text-red-400 bg-red-500/10 px-1 rounded">Low Bonus</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-zinc-400 mb-2 uppercase">City Base</label>
                        <input type="text" id="reg-location" class="w-full bg-zinc-900 border border-zinc-700 rounded p-3 text-white focus:border-pink-500 text-sm transition-colors" placeholder="e.g. Miami, NYC">
                        <p class="text-[10px] text-zinc-500 mt-2">Influences trending topics.</p>
                    </div>
                </div>

                <!-- Photo Upload ID -->
                <div>
                    <label class="block text-xs font-semibold text-zinc-400 mb-2 uppercase">Biometric Verification</label>
                    <div class="flex items-center gap-4 bg-zinc-800/50 p-3 rounded border border-zinc-800">
                        <div id="id-preview-box" class="w-16 h-16 rounded bg-black border border-zinc-700 overflow-hidden relative flex-shrink-0">
                            <div id="scan-overlay" class="hidden absolute inset-0 bg-green-500/20 z-10">
                                <div class="scan-line"></div>
                            </div>
                            <img id="id-preview-img" src="" class="w-full h-full object-cover hidden">
                            <i id="id-placeholder-icon" data-lucide="scan-face" class="w-6 h-6 text-zinc-600 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>
                        </div>
                        <div class="flex-1">
                            <input type="file" id="reg-photo" accept="image/*" onchange="handleIdUpload()" class="hidden">
                            <button onclick="document.getElementById('reg-photo').click()" class="text-xs bg-zinc-700 hover:bg-zinc-600 text-white py-1.5 px-3 rounded transition mb-1">
                                Upload Photo ID
                            </button>
                            <div id="verification-status" class="text-[10px] text-zinc-500">Required for payouts.</div>
                        </div>
                    </div>
                </div>

                <button onclick="submitRegistration()" id="btn-register" class="w-full bg-white text-black hover:bg-zinc-200 font-bold py-3.5 rounded mt-4 uppercase tracking-widest transition-all opacity-50 cursor-not-allowed" disabled>
                    Initialize Account
                </button>
            </div>
        </div>
    </div>

    <!-- TIER INFO MODAL -->
    <div id="tier-modal" class="hidden fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-zinc-900 border border-zinc-700 p-6 rounded-xl max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Career Ladder</h3>
                <button onclick="closeTierModal()" class="text-zinc-500 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            
            <div class="space-y-3 text-sm">
                <div class="bg-zinc-800/50 p-3 rounded border border-zinc-700 flex justify-between items-center">
                    <div>
                        <div class="font-bold text-zinc-400">OPPRESSED</div>
                        <div class="text-[10px] text-zinc-500">Starting Rank</div>
                    </div>
                    <div class="text-right">
                        <div class="text-red-400 font-mono font-bold">50% TAX</div>
                        <div class="text-[10px] text-zinc-500">+$0 Bonus/Like</div>
                    </div>
                </div>
                <div class="flex justify-center"><i data-lucide="arrow-down" class="text-zinc-600 w-4 h-4"></i></div>
                <div class="bg-zinc-800/50 p-3 rounded border-l-2 border-purple-500 flex justify-between items-center">
                    <div>
                        <div class="font-bold text-purple-400">FIGHTER</div>
                        <div class="text-[10px] text-zinc-500">Req: 500 Subs</div>
                    </div>
                    <div class="text-right">
                        <div class="text-orange-400 font-mono font-bold">40% TAX</div>
                        <div class="text-[10px] text-zinc-500">+$3 Bonus/Like</div>
                    </div>
                </div>
                <div class="flex justify-center"><i data-lucide="arrow-down" class="text-zinc-600 w-4 h-4"></i></div>
                <div class="bg-zinc-800/50 p-3 rounded border-l-2 border-pink-500 flex justify-between items-center shadow-[0_0_15px_rgba(236,72,153,0.1)]">
                    <div>
                        <div class="font-bold text-pink-500">QUEEN</div>
                        <div class="text-[10px] text-zinc-500">Req: 5,000 Subs + Studio</div>
                    </div>
                    <div class="text-right">
                        <div class="text-green-400 font-mono font-bold">25% TAX</div>
                        <div class="text-[10px] text-zinc-500">+$5 Bonus/Like</div>
                    </div>
                </div>
            </div>
            <p class="text-center text-[10px] text-zinc-500 mt-6">Tax is deducted daily from gross earnings.</p>
        </div>
    </div>

    <!-- SHOP MODAL -->
    <div id="shop-modal" class="hidden fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4">
        <div class="bg-zinc-900 border border-zinc-700 p-6 rounded-xl max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="shopping-bag" class="text-pink-500"></i> Lifestyle & Setup</h3>
                <button onclick="closeShopModal()" class="text-zinc-500 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            
            <div class="space-y-3">
                <div class="text-xs text-zinc-500 font-bold uppercase tracking-wider mb-2">Services</div>
                <div class="flex justify-between items-center bg-zinc-800 p-3 rounded">
                    <div>
                        <div class="font-bold text-white text-sm">Spa Day</div>
                        <div class="text-[10px] text-zinc-400">Restores +40 Sanity</div>
                    </div>
                    <button onclick="buyItem('spa', 100)" class="bg-zinc-700 hover:bg-green-600 text-white text-xs px-3 py-1.5 rounded font-bold transition">$100</button>
                </div>
                <div class="flex justify-between items-center bg-zinc-800 p-3 rounded">
                    <div>
                        <div class="font-bold text-white text-sm">PR Campaign</div>
                        <div class="text-[10px] text-zinc-400">Restores +25 Reputation</div>
                    </div>
                    <button onclick="buyItem('pr', 250)" class="bg-zinc-700 hover:bg-green-600 text-white text-xs px-3 py-1.5 rounded font-bold transition">$250</button>
                </div>
                
                <div class="text-xs text-zinc-500 font-bold uppercase tracking-wider mb-2 mt-4">Equipment Upgrades</div>
                
                <div class="flex justify-between items-center bg-zinc-800 p-3 rounded">
                    <div>
                        <div class="font-bold text-white text-sm">Ring Light</div>
                        <div class="text-[10px] text-zinc-400">+5% Tip Chance</div>
                    </div>
                    <button onclick="buyItem('ringlight', 200)" id="btn-buy-ringlight" class="bg-zinc-700 hover:bg-green-600 text-white text-xs px-3 py-1.5 rounded font-bold transition">$200</button>
                </div>
                
                <div class="flex justify-between items-center bg-zinc-800 p-3 rounded">
                    <div>
                        <div class="font-bold text-white text-sm">4K Mirrorless</div>
                        <div class="text-[10px] text-zinc-400">+15% Subscriber Growth</div>
                    </div>
                    <button onclick="buyItem('mirrorless', 1500)" id="btn-buy-mirrorless" class="bg-zinc-700 hover:bg-green-600 text-white text-xs px-3 py-1.5 rounded font-bold transition">$1,500</button>
                </div>

                <div class="flex justify-between items-center bg-zinc-800 p-3 rounded border border-yellow-900/30">
                    <div>
                        <div class="font-bold text-yellow-500 text-sm">Pro Studio</div>
                        <div class="text-[10px] text-zinc-400">Unlocks QUEEN Rank</div>
                    </div>
                    <button onclick="buyItem('studio', 5000)" id="btn-buy-studio" class="bg-zinc-700 hover:bg-green-600 text-white text-xs px-3 py-1.5 rounded font-bold transition">$5,000</button>
                </div>
                
                <div class="text-xs text-zinc-500 font-bold uppercase tracking-wider mb-2 mt-4">Security</div>
                <div class="flex justify-between items-center bg-zinc-800 p-3 rounded">
                    <div>
                        <div class="font-bold text-white text-sm">Cyber Security</div>
                        <div class="text-[10px] text-zinc-400">Prevents Leaks</div>
                    </div>
                    <button onclick="buyItem('security', 500)" id="btn-buy-security" class="bg-zinc-700 hover:bg-green-600 text-white text-xs px-3 py-1.5 rounded font-bold transition">$500</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AGENCY MODAL -->
    <div id="agency-modal" class="hidden fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4">
        <div class="bg-zinc-900 border border-purple-600 p-6 rounded-xl max-w-2xl w-full relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-purple-600"></div>
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-xl font-bold text-white uppercase italic tracking-widest">Agency Selector</h3>
                    <p class="text-zinc-400 text-xs">Choose your management style.</p>
                </div>
                <button onclick="closeAgencyModal()" class="text-zinc-500 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            
            <div id="agency-selection-ui" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <!-- Chatter Farm -->
                <div onclick="selectAgencyOption('chatter')" id="agency-chatter" class="agency-card cursor-pointer bg-zinc-800 p-4 rounded border border-zinc-700 hover:bg-zinc-700 transition">
                    <div class="font-bold text-blue-400 mb-1">Chatter Farm</div>
                    <div class="text-xs text-zinc-300 mb-2 h-8">"We handle the DMs."</div>
                    <ul class="text-[10px] text-zinc-400 space-y-1 mb-3">
                        <li class="text-green-400">+10 Sanity / Day</li>
                        <li class="text-red-400">40% Tax</li>
                    </ul>
                </div>

                <!-- Viral House -->
                <div onclick="selectAgencyOption('viral')" id="agency-viral" class="agency-card cursor-pointer bg-zinc-800 p-4 rounded border border-zinc-700 hover:bg-zinc-700 transition">
                    <div class="font-bold text-pink-500 mb-1">Viral House</div>
                    <div class="text-xs text-zinc-300 mb-2 h-8">"Go big or go home."</div>
                    <ul class="text-[10px] text-zinc-400 space-y-1 mb-3">
                        <li class="text-green-400">2x Sub Growth</li>
                        <li class="text-red-400">50% Tax</li>
                        <li class="text-orange-400">Forced WILD Content</li>
                    </ul>
                </div>

                <!-- Boutique Mgmt -->
                <div onclick="selectAgencyOption('boutique')" id="agency-boutique" class="agency-card cursor-pointer bg-zinc-800 p-4 rounded border border-zinc-700 hover:bg-zinc-700 transition">
                    <div class="font-bold text-yellow-400 mb-1">Boutique Mgmt</div>
                    <div class="text-xs text-zinc-300 mb-2 h-8">"Premium service."</div>
                    <ul class="text-[10px] text-zinc-400 space-y-1 mb-3">
                        <li class="text-green-400">Only 20% Tax</li>
                        <li class="text-red-400">$35/Day Retainer</li>
                    </ul>
                </div>
            </div>

            <button onclick="signAgency()" id="btn-sign-agency" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded text-xs uppercase disabled:opacity-50 disabled:cursor-not-allowed" disabled>Select an Agency</button>
            
            <!-- Active Contract View -->
            <div id="agency-active-ui" class="hidden text-center py-4">
                <div class="text-green-400 font-bold text-lg mb-2">CURRENTLY SIGNED</div>
                <div class="text-zinc-400 text-sm mb-4">Agency: <span id="current-agency-name" class="text-white font-bold">...</span></div>
                <button onclick="breakContract()" class="bg-red-600 hover:bg-red-500 text-white px-6 py-3 rounded font-bold uppercase text-xs">Break Contract ($500 Penalty)</button>
            </div>
        </div>
    </div>

    <!-- MINI GAME MODAL -->
    <div id="minigame-modal" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
        <div class="bg-zinc-900 border-2 border-yellow-600 p-6 rounded-xl max-w-sm w-full text-center relative overflow-hidden">
            <h2 class="text-2xl font-black text-yellow-500 mb-2 uppercase italic">High Stakes Bet</h2>
            <p class="text-zinc-300 text-sm mb-4">"I bet $100 you can't guess the next card!"</p>
            
            <div class="bg-black/40 p-3 rounded mb-4 text-xs text-left border border-zinc-800">
                <div class="flex justify-between mb-2">
                    <span class="text-green-400 font-bold">WIN:</span>
                    <span>Get <span class="text-green-400">$100</span> Cash</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-red-500 font-bold">LOSE:</span>
                    <span class="text-right">Post <span id="penalty-req" class="text-pink-400 font-bold">Feet Pic</span><br><span class="text-[10px] text-zinc-500">(Earns $0.00)</span></span>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="closeMiniGame()" class="flex-1 bg-zinc-800 hover:bg-zinc-700 py-3 rounded text-xs text-zinc-400">Decline</button>
                <button onclick="startCardGame()" class="flex-1 bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-3 rounded text-xs uppercase">Accept Challenge</button>
            </div>
        </div>
    </div>

    <!-- ACTIVE CARD GAME MODAL -->
    <div id="card-game-modal" class="hidden fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4">
        <div class="bg-zinc-900 p-8 rounded-xl w-full max-w-xs text-center border border-zinc-700">
            <h3 class="text-zinc-500 text-xs uppercase mb-6 tracking-widest">High / Low</h3>
            
            <div class="flex justify-center items-center gap-4 mb-8">
                <div class="w-24 h-36 bg-white rounded flex items-center justify-center text-5xl font-black text-black" id="card-display">7</div>
                <div class="w-24 h-36 bg-zinc-800 rounded flex items-center justify-center border-2 border-zinc-600 text-zinc-500 text-2xl font-bold" id="card-mystery">?</div>
            </div>

            <div class="flex gap-2">
                <button onclick="guessCard('lower')" class="flex-1 bg-red-900/50 hover:bg-red-900 border border-red-800 text-red-200 py-3 rounded font-bold">LOWER ‚ñº</button>
                <button onclick="guessCard('higher')" class="flex-1 bg-green-900/50 hover:bg-green-900 border border-green-800 text-green-200 py-3 rounded font-bold">HIGHER ‚ñ≤</button>
            </div>
        </div>
    </div>

    <!-- POST CREATION MODAL -->
    <div id="post-modal" class="hidden fixed inset-0 bg-black/80 z-40 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-zinc-900 p-6 rounded-xl max-w-md w-full border border-zinc-700 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white" id="post-modal-title">New Content</h3>
                <button onclick="closePostModal()" class="text-zinc-500 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            
            <!-- PENALTY MODE UI -->
            <div id="penalty-ui" class="hidden mb-6 bg-red-950/40 border border-red-900/50 p-4 rounded text-center">
                <p class="text-red-500 text-xs font-bold uppercase mb-2 tracking-widest">DEBT COLLECTION</p>
                <p class="text-white text-lg font-bold mt-1 mb-2"><span id="penalty-target">...</span></p>
                <p class="text-[10px] text-zinc-500 uppercase">This post will earn $0.00</p>
            </div>

            <!-- NORMAL MODE UI -->
            <div id="normal-ui" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-zinc-500 uppercase mb-2 block">Vibe Check</label>
                    <div class="grid grid-cols-3 gap-2">
                        <div onclick="selectVibe('modest')" id="vibe-modest" class="vibe-option selected cursor-pointer p-3 rounded border border-zinc-700 bg-zinc-800/50 text-center hover:bg-zinc-800 transition">
                            <span class="text-xl block mb-1">üôÇ</span>
                            <span class="text-xs font-bold block text-zinc-300">Modest</span>
                            <div class="text-[9px] text-green-400 mt-1">+5 Rep</div>
                            <div class="text-[9px] text-zinc-500">Low Pay</div>
                        </div>
                        <div onclick="selectVibe('tease')" id="vibe-tease" class="vibe-option cursor-pointer p-3 rounded border border-zinc-700 bg-zinc-800/50 text-center hover:bg-zinc-800 transition">
                            <span class="text-xl block mb-1">üòè</span>
                            <span class="text-xs font-bold block text-zinc-300">Tease</span>
                            <div class="text-[9px] text-red-400 mt-1">-5 Rep</div>
                            <div class="text-[9px] text-zinc-500">Med Pay</div>
                        </div>
                        <div onclick="selectVibe('wild')" id="vibe-wild" class="vibe-option cursor-pointer p-3 rounded border border-zinc-700 bg-zinc-800/50 text-center hover:bg-zinc-800 transition">
                            <span class="text-xl block mb-1">üî•</span>
                            <span class="text-xs font-bold text-pink-500 block">WILD</span>
                            <div class="text-[9px] text-red-600 mt-1">-15 Rep</div>
                            <div class="text-[9px] text-zinc-500">High Pay</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COMMON UI -->
            <div class="space-y-4 mt-6">
                <div>
                    <label class="text-xs font-bold text-zinc-500 uppercase mb-2 block">Media Gallery (Max 3)</label>
                    <div id="media-list" class="flex gap-2 mb-2 overflow-x-auto pb-2">
                        <!-- Media Thumbnails Go Here -->
                    </div>
                    
                    <div class="flex gap-2 mb-2">
                        <input type="file" id="post-file" class="hidden" accept="image/*,video/*" onchange="previewFile()">
                        <button onclick="document.getElementById('post-file').click()" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-xs py-2 px-4 rounded transition border border-zinc-700">
                            <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i> Add File
                        </button>
                        <input type="text" id="post-url" class="flex-1 bg-zinc-950 border border-zinc-800 rounded px-3 text-xs text-white focus:outline-none focus:border-zinc-600" placeholder="Paste URL">
                        <button onclick="addUrl()" class="bg-zinc-800 hover:bg-zinc-700 px-3 rounded border border-zinc-700"><i data-lucide="plus" class="w-4 h-4 text-white"></i></button>
                    </div>
                    <div id="media-preview-area" class="w-full h-48 bg-black border border-zinc-800 rounded flex items-center justify-center overflow-hidden relative">
                        <span class="text-zinc-600 text-xs">No media selected</span>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-zinc-500 uppercase mb-2 block">Caption</label>
                    <textarea id="post-caption" class="w-full bg-zinc-950 p-3 rounded border border-zinc-800 h-20 text-sm focus:outline-none focus:border-zinc-600 text-white resize-none" placeholder="Write something engaging..."></textarea>
                </div>
                
                <button onclick="submitPost()" id="btn-submit-post" class="w-full bg-white text-black hover:bg-zinc-200 font-bold py-3 rounded mt-2 transition-colors">
                    Publish
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN GAME CONTAINER -->
    <div id="game-container" class="hidden max-w-6xl w-full grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Header -->
        <div class="col-span-1 lg:col-span-3 bg-zinc-900 p-5 rounded-xl border border-zinc-800 flex flex-wrap justify-between items-center shadow-lg">
            <div class="flex items-center gap-4">
                <div class="relative">
                    <img id="player-avatar-display" src="" class="w-14 h-14 rounded-full object-cover border-2 border-zinc-700 bg-black">
                    <div class="absolute -bottom-1 -right-1 bg-green-500 w-4 h-4 rounded-full border-2 border-zinc-900"></div>
                </div>
                <div>
                    <div id="player-handle-display" class="font-bold text-xl text-white">@user</div>
                    <div class="text-xs text-zinc-500 flex items-center gap-1 mt-0.5">
                        <i data-lucide="map-pin" class="w-3 h-3"></i> <span id="location-display">Unknown</span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-8 mt-4 sm:mt-0 flex-1 justify-end">
                <!-- Rep/Sanity Bars -->
                <div class="hidden md:flex flex-col gap-2 w-48 mr-4">
                    <div class="flex items-center gap-2">
                        <i data-lucide="award" class="w-3 h-3 text-blue-400"></i>
                        <div class="w-full h-1.5 bg-zinc-800 rounded-full group relative">
                            <div id="rep-bar" class="bg-blue-500 h-full rounded-full transition-all" style="width: 70%"></div>
                            <div class="absolute -top-4 left-0 text-[9px] text-zinc-500 hidden group-hover:block">Reputation</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <i data-lucide="brain" class="w-3 h-3 text-pink-400"></i>
                        <div class="w-full h-1.5 bg-zinc-800 rounded-full group relative">
                            <div id="sanity-bar" class="bg-pink-500 h-full rounded-full transition-all" style="width: 100%"></div>
                            <div class="absolute -top-4 left-0 text-[9px] text-zinc-500 hidden group-hover:block">Sanity</div>
                        </div>
                    </div>
                </div>

                <div class="text-right">
                    <div class="text-[10px] text-zinc-500 uppercase font-bold tracking-wider">Net Worth</div>
                    <div class="text-2xl font-bold font-mono tracking-tight" id="money-display-wrapper">
                        <span id="money-display" class="text-red-500">-$500.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- LEFT COLUMN: Phone -->
        <div class="col-span-1 lg:col-span-1 flex justify-center">
            <div class="w-full max-w-sm bg-black rounded-[3rem] p-3 border-4 border-zinc-800 shadow-2xl relative overflow-hidden h-[700px] flex flex-col">
                <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-24 h-6 bg-black rounded-b-xl z-20"></div>
                
                <div class="bg-zinc-950 flex-1 rounded-[2.2rem] overflow-hidden flex flex-col relative phone-screen">
                    <!-- App Header -->
                    <div class="h-16 flex items-center justify-between px-5 border-b border-zinc-800 bg-zinc-950/80 backdrop-blur z-10 pt-4">
                        <span class="font-bold tracking-tight text-white italic">FanClub</span>
                        <button onclick="toggleArchive()" class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center text-zinc-400 hover:text-white">
                            <i data-lucide="user" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <!-- EMPTY STATE -->
                    <div id="feed-empty" class="flex-1 flex flex-col items-center justify-center p-6 text-center">
                        <div class="relative mb-6">
                            <img id="phone-avatar-big" src="" class="w-24 h-24 rounded-full object-cover border-4 border-zinc-900 shadow-xl">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 w-full mb-6">
                            <div class="bg-zinc-900/50 p-3 rounded border border-zinc-800/50">
                                <span class="block text-[10px] text-zinc-500 uppercase tracking-wider">Balance</span>
                                <span class="font-mono text-sm font-bold text-white" id="phone-balance">-$500</span>
                            </div>
                            <div class="bg-zinc-900/50 p-3 rounded border border-zinc-800/50">
                                <span class="block text-[10px] text-zinc-500 uppercase tracking-wider">Rate</span>
                                <span class="font-mono text-sm font-bold text-zinc-300" id="phone-rate">$0/like</span>
                            </div>
                        </div>

                        <button onclick="openPostModal()" id="btn-create-post" class="w-full bg-white text-black hover:bg-zinc-200 font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-2 mb-3 transition-all">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i> Create Post
                        </button>
                        
                        <p id="post-limit-msg" class="text-xs text-red-500 mt-2 hidden font-medium">Need sleep to recharge.</p>
                    </div>

                    <!-- ACTIVE POST STATE -->
                    <div id="feed-active" class="hidden flex-col h-full overflow-y-auto pb-20 scroll-smooth no-scrollbar">
                        <div id="feed-media-container" class="bg-black w-full flex items-center justify-center relative group overflow-hidden border-b border-zinc-900 carousel-track h-[450px]">
                            <!-- CAROUSEL ITEMS INJECTED HERE -->
                        </div>

                        <div class="flex items-center justify-between p-4 border-b border-zinc-900">
                            <div class="flex flex-col">
                                <div class="flex gap-2 items-center">
                                    <i data-lucide="heart" class="w-5 h-5 text-red-500 fill-red-500 animate-pop"></i>
                                    <span class="text-white font-bold text-lg" id="live-likes">0</span>
                                </div>
                                <div class="text-xs text-zinc-500 font-mono mt-0.5">Earned: $<span id="live-earnings" class="text-green-400">0.00</span></div>
                            </div>
                            <div id="virality-badge" class="text-[10px] font-bold px-2 py-1 rounded bg-zinc-900 text-zinc-500 uppercase border border-zinc-800">
                                Modest
                            </div>
                        </div>

                        <div class="px-4 pb-2 pt-3">
                            <div class="text-sm text-zinc-300">
                                <span class="font-bold text-white mr-1" id="post-handle">@user</span>
                                <span id="post-caption-display" class="text-zinc-400">...</span>
                            </div>
                        </div>

                        <div class="px-4 pt-4 border-t border-zinc-900 mt-2">
                            <h4 class="text-[10px] font-bold text-zinc-600 uppercase mb-3 tracking-widest">Comments</h4>
                            <div id="comments-container" class="space-y-3 text-sm pb-4"></div>
                        </div>
                    </div>

                    <!-- ARCHIVE -->
                    <div id="feed-archive" class="hidden flex-col h-full overflow-y-auto p-4 space-y-4 pb-20">
                        <h2 class="text-xs font-bold text-zinc-600 uppercase text-center mb-2 tracking-widest">Archive</h2>
                        <div id="archive-container" class="space-y-4"></div>
                    </div>
                    
                    <button id="btn-reply" onclick="replyToComments()" class="hidden absolute bottom-6 right-6 bg-blue-600 hover:bg-blue-500 text-white p-4 rounded-full shadow-lg z-20 animate-bounce">
                        <i data-lucide="message-square" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Stats & Controls -->
        <div class="col-span-1 lg:col-span-2 flex flex-col gap-6">
            
            <!-- Rank Progress -->
            <div class="glass-panel p-6 rounded-xl flex flex-col md:flex-row justify-between items-start gap-4">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-zinc-500 text-xs uppercase font-bold tracking-wider">Current Tier</span>
                        <button onclick="openTierModal()" class="text-[10px] bg-zinc-800 hover:bg-zinc-700 text-zinc-300 px-2 py-0.5 rounded border border-zinc-700 transition">View Benefits</button>
                    </div>
                    <div class="text-4xl font-black text-zinc-600 tracking-tight" id="tier-name">OPPRESSED</div>
                    <div class="text-sm text-zinc-400 mt-1 flex items-center gap-2">
                        Tax Rate: <span id="current-tax-rate" class="text-red-400 font-mono">50%</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="flex items-center gap-2 justify-end text-white">
                        <i data-lucide="users" class="w-5 h-5 text-zinc-500"></i>
                        <span class="text-3xl font-bold" id="subs-display">0</span>
                    </div>
                    <div class="text-xs text-zinc-500 uppercase tracking-wider font-bold">Subscribers</div>
                    <div class="text-xs text-zinc-600 mt-1" id="rate-info-rank">Rank Bonus: +$0</div>
                </div>
            </div>

            <!-- Dashboard -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                <!-- Expenses -->
                <div class="glass-panel p-6 rounded-xl">
                    <h2 class="text-lg font-bold flex items-center gap-2 text-white mb-6 border-b border-zinc-800 pb-2">
                        <i data-lucide="receipt" class="text-zinc-500 w-5 h-5"></i> Daily Burn
                    </h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center text-zinc-400">
                            <span>Apartment Rent</span>
                            <span id="cost-rent" class="text-white font-mono">-$75.00</span>
                        </div>
                        <div class="flex justify-between items-center text-zinc-400">
                            <span>Food & Lifestyle</span>
                            <span id="cost-living" class="text-white font-mono">-$40.00</span>
                        </div>
                        <div id="extra-costs-container"></div>
                        <div id="tax-container" class="hidden flex justify-between items-center bg-red-950/20 p-2 rounded border border-red-900/30">
                            <span class="text-red-400 text-xs font-bold uppercase">Platform Tax</span>
                            <span id="cost-tax" class="text-red-400 font-mono">-$0.00</span>
                        </div>
                        <div class="flex justify-between pt-4 border-t border-zinc-800 mt-2">
                            <span class="font-bold text-zinc-500 text-xs uppercase tracking-wider pt-1">Total Deductions</span>
                            <span id="total-daily-cost" class="font-bold text-red-500 text-lg">-$115.00</span>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="glass-panel p-6 rounded-xl flex flex-col justify-between">
                    <div>
                        <h2 class="text-lg font-bold flex items-center gap-2 text-white mb-6 border-b border-zinc-800 pb-2">
                            <i data-lucide="gamepad-2" class="text-zinc-500 w-5 h-5"></i> Activities
                        </h2>
                        
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <button onclick="openShopModal()" class="bg-zinc-800 hover:bg-zinc-700 p-3 rounded text-sm flex flex-col items-center justify-center gap-1 border border-zinc-700">
                                <i data-lucide="shopping-bag" class="text-pink-500 w-5 h-5"></i>
                                <span class="text-zinc-300 text-xs font-bold">Shop</span>
                            </button>
                            <button onclick="openAgencyModal()" id="btn-agency" class="bg-zinc-800 hover:bg-zinc-700 p-3 rounded text-sm flex flex-col items-center justify-center gap-1 border border-zinc-700">
                                <i data-lucide="briefcase" class="text-purple-500 w-5 h-5"></i>
                                <span class="text-zinc-300 text-xs font-bold">Agency</span>
                            </button>
                        </div>
                        
                        <!-- Mini Game Trigger -->
                        <button onclick="triggerMiniGame()" id="btn-minigame" class="w-full bg-zinc-900 hover:bg-zinc-800 p-4 rounded text-sm flex items-center justify-between group border border-yellow-900/30 hover:border-yellow-700/50 transition-all">
                            <div class="text-left">
                                <span class="block font-bold text-yellow-500">Fan Challenge</span>
                                <span class="text-xs text-zinc-500 group-hover:text-zinc-400">Risk/Reward Mini-Game</span>
                            </div>
                            <i data-lucide="chevron-right" class="text-zinc-600 group-hover:text-white"></i>
                        </button>
                    </div>

                    <div class="mt-4">
                        <button onclick="endDay()" class="w-full bg-zinc-100 hover:bg-white text-black font-bold py-4 rounded-lg shadow-lg flex justify-center items-center gap-2 transition transform active:scale-95">
                            <i data-lucide="moon" class="w-4 h-4"></i> End Day & Process Bills
                        </button>
                        <p class="text-[10px] text-center text-zinc-600 mt-3">Rent is due every night.</p>
                    </div>
                </div>
            </div>
            
            <!-- Log -->
            <div class="bg-black/40 rounded-xl p-4 h-32 overflow-y-auto log-scroll border border-zinc-800 text-xs font-mono text-zinc-400" id="game-log">
                <div class="text-green-500">> System initialized. Debt: -$500.</div>
            </div>
        </div>

    </div>

    <!-- GAME OVER -->
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black flex items-center justify-center z-[80]">
        <div class="text-center p-10 border border-red-900 bg-zinc-950 rounded-2xl max-w-lg w-full">
            <h2 class="text-6xl font-black text-red-600 mb-2 tracking-tighter" id="game-over-title">BANKRUPT</h2>
            <p class="text-zinc-400 text-lg mb-8 uppercase tracking-widest" id="game-over-msg">Career Terminated</p>
            
            <div class="bg-red-950/20 p-4 rounded border border-red-900/50 mb-8 text-left">
                <div class="flex justify-between text-sm mb-1">
                    <span class="text-zinc-500">Final Rank:</span>
                    <span id="final-rank" class="text-white font-bold">...</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-zinc-500">Subscribers:</span>
                    <span id="final-subs" class="text-white font-bold">...</span>
                </div>
            </div>

            <button onclick="location.reload()" class="w-full bg-white text-black font-bold py-4 rounded hover:bg-zinc-200 uppercase tracking-widest transition">Restart Simulation</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        const RANKS = [
            { name: "OPPRESSED", threshold: 0, color: "text-zinc-600", desc: "Starting Out", bonus: 0, tax: 0.50 },
            { name: "FIGHTER", threshold: 500, color: "text-purple-400", desc: "Rising Star", bonus: 3, tax: 0.40 },
            { name: "QUEEN", threshold: 5000, color: "text-pink-500", desc: "Platform Elite", bonus: 5, tax: 0.25 }
        ];

        // Adjusted Bonuses (Harder)
        const AGE_DATA = {
            "18-19": { postBonus: 10, likeBonus: 2 },
            "20-24": { postBonus: 5, likeBonus: 1 },
            "25+":   { postBonus: 2, likeBonus: 0.5 }
        };

        const AGENCIES = {
            "chatter": { name: "Chatter Farm", tax: 0.40, retainer: 0, desc: "+10 Sanity/Day", color: "text-blue-400" },
            "viral": { name: "Viral House", tax: 0.50, retainer: 0, desc: "Forces Wild, 2x Growth", color: "text-pink-500" },
            "boutique": { name: "Boutique Mgmt", tax: 0.20, retainer: 35, desc: "Low Tax, High Fee", color: "text-yellow-400" }
        };

        const BASE_LIKE_RATE = 2.0; 
        const PENALTY_TASKS = ["Feet Pic", "Cosplay", "Abs", "No Makeup", "Messy Hair"];

        const COMMENTS_WILD = ["OMG YES", "Take my money", "Finally", "Queen energy", "Obsessed"];
        const COMMENTS_SAFE = ["Cute fit", "Nice lighting", "Pretty", "Okay I guess", "Smile more", "Glow up"];
        const COMMENTS_BAD = ["Boring", "Unsubbed", "Show more", "Waste of time"];

        // --- STATE ---
        let player = { handle: "", photo: null, ageRange: "20-24", location: "Los Angeles" };
        let state = {
            day: 1,
            money: -500.00,
            energy: 100,
            reputation: 70,
            sanity: 100,
            subscribers: 0,
            postedToday: false,
            rankIdx: 0,
            costs: { rent: 75, living: 40, extra: [], lastTax: 0 }, 
            activePost: null,
            pastPosts: [],
            tempMediaUrls: [], // Updated to Array
            currentEarnings: 0,
            selectedVibe: 'modest',
            lastVibe: null,
            penaltyActive: false,
            penaltyTask: "",
            agency: null, // Stores agency key (chatter, viral, boutique)
            upgrades: { camera: false, security: false, studio: false, ringlight: false }
        };
        let liveInterval = null;
        let cardGame = { current: 0 };
        let selectedAgencyTemp = null;

        // --- HELPER ---
        function setText(id, text) {
            const el = document.getElementById(id);
            if(el) el.innerText = text;
        }

        // --- REGISTRATION ---
        function selectAge(range) {
            player.ageRange = range;
            document.querySelectorAll('.age-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById(`age-${range}`).classList.add('selected');
        }

        function handleIdUpload() {
            const file = document.getElementById('reg-photo').files[0];
            if(!file) return;
            const url = URL.createObjectURL(file);
            player.photo = url;
            
            document.getElementById('id-placeholder-icon').classList.add('hidden');
            const img = document.getElementById('id-preview-img');
            img.src = url;
            img.classList.remove('hidden');
            
            setText('verification-status', "Verifying identity...");
            document.getElementById('scan-overlay').classList.remove('hidden');

            setTimeout(() => {
                document.getElementById('scan-overlay').classList.add('hidden');
                setText('verification-status', "Verified");
                document.getElementById('verification-status').className = "text-green-500 font-bold";
                document.getElementById('btn-register').disabled = false;
                document.getElementById('btn-register').classList.remove('opacity-50', 'cursor-not-allowed');
            }, 1500);
        }

        function submitRegistration() {
            const h = document.getElementById('reg-handle').value;
            const loc = document.getElementById('reg-location').value;
            if(!h || !loc) return alert("Fill all fields.");
            
            player.handle = "@" + h.replace('@','');
            player.location = loc;
            if(!document.querySelector('.age-btn.selected')) selectAge('20-24');

            setText('player-handle-display', player.handle);
            document.getElementById('player-avatar-display').src = player.photo;
            document.getElementById('phone-avatar-big').src = player.photo;
            setText('location-display', player.location);
            
            document.getElementById('registration-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            
            initGame();
        }

        function initGame() {
            lucide.createIcons();
            updateUI();
            log(`Account active. Debt: -$500.00`, "text-red-500");
        }

        // --- MODALS ---
        function openTierModal() { document.getElementById('tier-modal').classList.remove('hidden'); }
        function closeTierModal() { document.getElementById('tier-modal').classList.add('hidden'); }
        
        function openShopModal() { document.getElementById('shop-modal').classList.remove('hidden'); }
        function closeShopModal() { document.getElementById('shop-modal').classList.add('hidden'); }

        function openAgencyModal() { 
            document.getElementById('agency-modal').classList.remove('hidden'); 
            if(state.agency) {
                document.getElementById('agency-selection-ui').classList.add('hidden');
                document.getElementById('btn-sign-agency').classList.add('hidden');
                document.getElementById('agency-active-ui').classList.remove('hidden');
                setText('current-agency-name', AGENCIES[state.agency].name);
            } else {
                document.getElementById('agency-selection-ui').classList.remove('hidden');
                document.getElementById('btn-sign-agency').classList.remove('hidden');
                document.getElementById('agency-active-ui').classList.add('hidden');
            }
        }
        function closeAgencyModal() { document.getElementById('agency-modal').classList.add('hidden'); }

        // --- AGENCY ---
        function selectAgencyOption(type) {
            selectedAgencyTemp = type;
            document.querySelectorAll('.agency-card').forEach(c => c.classList.remove('selected'));
            document.getElementById(`agency-${type}`).classList.add('selected');
            document.getElementById('btn-sign-agency').disabled = false;
            document.getElementById('btn-sign-agency').classList.remove('opacity-50', 'cursor-not-allowed');
        }

        function signAgency() {
            if(!selectedAgencyTemp) return;
            state.agency = selectedAgencyTemp;
            closeAgencyModal();
            log(`Signed with ${AGENCIES[state.agency].name}.`, "text-purple-400");
            updateUI();
        }

        function breakContract() {
            if(state.money < 500) return alert("Need $500 to break contract!");
            state.money -= 500;
            log(`Contract Broken. Paid $500 penalty.`, "text-red-400");
            state.agency = null;
            selectedAgencyTemp = null;
            closeAgencyModal();
            updateUI();
        }

        // --- SHOP ---
        function buyItem(item, cost) {
            if(state.money < cost) return alert("Not enough cash!");
            state.money -= cost;
            
            if(item === 'spa') {
                state.sanity = Math.min(100, state.sanity + 40);
                log("Spa Day: Sanity restored.", "text-pink-400");
            }
            if(item === 'pr') {
                state.reputation = Math.min(100, state.reputation + 25);
                log("PR Campaign: Reputation improved.", "text-blue-400");
            }
            if(item === 'security') {
                state.upgrades.security = true;
                document.getElementById('btn-buy-security').disabled = true;
                document.getElementById('btn-buy-security').innerText = "Owned";
                log("Security System installed.", "text-zinc-300");
            }
            if(item === 'ringlight') {
                state.upgrades.ringlight = true;
                document.getElementById('btn-buy-ringlight').disabled = true;
                document.getElementById('btn-buy-ringlight').innerText = "Owned";
                log("Ring Light bought.", "text-zinc-300");
            }
            if(item === 'mirrorless') {
                state.upgrades.camera = true; // Camera logic
                document.getElementById('btn-buy-mirrorless').disabled = true;
                document.getElementById('btn-buy-mirrorless').innerText = "Owned";
                log("4K Mirrorless bought.", "text-yellow-400");
            }
            if(item === 'studio') {
                state.upgrades.studio = true;
                document.getElementById('btn-buy-studio').disabled = true;
                document.getElementById('btn-buy-studio').innerText = "Owned";
                log("Pro Studio bought. Queen rank unlocked.", "text-purple-400");
            }
            updateUI();
        }

        // --- MINI GAME ---
        function triggerMiniGame() {
            if(state.money < -1000) return alert("You are too bankrupt to bet.");
            const task = PENALTY_TASKS[Math.floor(Math.random() * PENALTY_TASKS.length)];
            setText('penalty-req', task);
            document.getElementById('minigame-modal').classList.remove('hidden');
        }

        function closeMiniGame() { document.getElementById('minigame-modal').classList.add('hidden'); }

        function startCardGame() {
            closeMiniGame();
            document.getElementById('card-game-modal').classList.remove('hidden');
            cardGame.current = Math.floor(Math.random() * 13) + 1;
            setText('card-display', cardGame.current);
            setText('card-mystery', "?");
        }

        function guessCard(guess) {
            const next = Math.floor(Math.random() * 13) + 1;
            setText('card-mystery', next);
            
            let win = false;
            if(guess === 'higher' && next >= cardGame.current) win = true;
            if(guess === 'lower' && next <= cardGame.current) win = true;
            
            setTimeout(() => {
                document.getElementById('card-game-modal').classList.add('hidden');
                if(win) {
                    state.money += 100;
                    log("Mini-game WIN! +$100.00", "text-green-400 font-bold");
                } else {
                    state.penaltyActive = true;
                    state.penaltyTask = document.getElementById('penalty-req').innerText;
                    log(`Mini-game LOST. Penalty debt: ${state.penaltyTask}`, "text-red-500 font-bold");
                }
                updateUI();
            }, 1000);
        }

        // --- POSTING ---
        function selectVibe(vibe) {
            if(state.penaltyActive) return;
            if(state.agency === 'viral' && vibe !== 'wild') {
                alert("Viral House Agency requires WILD content only!");
                return;
            }
            state.selectedVibe = vibe;
            document.querySelectorAll('.vibe-option').forEach(e => e.classList.remove('selected'));
            document.getElementById(`vibe-${vibe}`).classList.add('selected');
        }

        function previewFile() {
            const file = document.getElementById('post-file').files[0];
            if(file) {
                const url = URL.createObjectURL(file);
                addMediaToState(url);
            }
        }

        function addUrl() {
            const url = document.getElementById('post-url').value;
            if(url) {
                addMediaToState(url);
                document.getElementById('post-url').value = "";
            }
        }

        function addMediaToState(url) {
            if(state.tempMediaUrls.length >= 3) return alert("Max 3 items per post.");
            state.tempMediaUrls.push(url);
            renderMediaList();
        }

        function renderMediaList() {
            const list = document.getElementById('media-list');
            if(!list) return; // Fix for null error
            
            list.innerHTML = "";
            state.tempMediaUrls.forEach((url, index) => {
                const img = document.createElement('img');
                img.src = url;
                img.className = "w-10 h-10 object-cover rounded border border-zinc-700 flex-shrink-0";
                list.appendChild(img);
            });
            
            const preview = document.getElementById('media-preview-area');
            if(!preview) return; // Safety Check

            // Preview area shows first image
            if(state.tempMediaUrls.length > 0) {
                preview.innerHTML = `<img src="${state.tempMediaUrls[0]}" class="w-full h-full object-cover">`;
            } else {
                preview.innerHTML = '<span class="text-zinc-600 text-xs">No media selected</span>';
            }
        }

        function openPostModal() {
            if(state.energy < 15) return log("Energy depleted. Sleep required.", "text-red-400");
            document.getElementById('post-modal').classList.remove('hidden');
            state.tempMediaUrls = [];
            renderMediaList();

            // Disable modest if agency viral
            if(state.agency === 'viral') {
                document.getElementById('vibe-modest').classList.add('disabled-option');
                document.getElementById('vibe-tease').classList.add('disabled-option');
                selectVibe('wild');
            } else {
                document.getElementById('vibe-modest').classList.remove('disabled-option');
                document.getElementById('vibe-tease').classList.remove('disabled-option');
            }

            if(state.penaltyActive) {
                document.getElementById('penalty-ui').classList.remove('hidden');
                document.getElementById('normal-ui').classList.add('hidden');
                setText('penalty-target', state.penaltyTask);
                setText('post-modal-title', "Settle Penalty");
                setText('btn-submit-post', "Upload Penalty Content");
                const sBtn = document.getElementById('btn-submit-post');
                if(sBtn) {
                    sBtn.classList.add('bg-red-600', 'text-white', 'hover:bg-red-500');
                    sBtn.classList.remove('bg-white', 'text-black');
                }
            } else {
                document.getElementById('penalty-ui').classList.add('hidden');
                document.getElementById('normal-ui').classList.remove('hidden');
                setText('post-modal-title', "New Content");
                setText('btn-submit-post', "Publish");
                const sBtn = document.getElementById('btn-submit-post');
                if(sBtn) {
                    sBtn.classList.remove('bg-red-600', 'text-white', 'hover:bg-red-500');
                    sBtn.classList.add('bg-white', 'text-black');
                }
                
                // Default vibe
                if(state.agency === 'viral') selectVibe('wild');
                else selectVibe(state.selectedVibe); 
            }
        }

        function closePostModal() { document.getElementById('post-modal').classList.add('hidden'); }

        function submitPost() {
            const caption = document.getElementById('post-caption').value;
            if(state.tempMediaUrls.length === 0) return alert("At least one media item required.");

            let cost = 15;
            let potentialLikes = 20; 
            let vibe = state.selectedVibe;
            let isPenalty = false;
            let repChange = 0;
            let sanityChange = -5;

            if(state.penaltyActive) {
                isPenalty = true;
                cost = 20;
                potentialLikes = 150; 
                vibe = "Penalty";
                state.penaltyActive = false;
                repChange = -10; 
                sanityChange = -15;
                
                const btn = document.getElementById('btn-create-post');
                if(btn) {
                    btn.classList.remove('bg-red-600', 'text-white', 'hover:bg-red-500');
                    btn.classList.add('bg-white', 'text-black');
                    btn.innerHTML = `<i data-lucide="plus-circle" class="w-5 h-5"></i> Create Post`;
                    lucide.createIcons();
                }
                log("Penalty fulfilled. Account unlocked.", "text-zinc-400");
            } else {
                if(vibe === 'modest') { 
                    cost = 15; potentialLikes = 15; 
                    repChange = 5; sanityChange = -2;
                }
                if(vibe === 'tease') { 
                    cost = 30; potentialLikes = 80; 
                    repChange = -2; sanityChange = -8;
                }
                if(vibe === 'wild') { 
                    cost = 60; potentialLikes = 300; 
                    repChange = -15; sanityChange = -25;
                }
            }

            if(state.energy < cost) return alert("Not enough energy.");

            state.energy -= cost;
            state.reputation = Math.max(0, Math.min(100, state.reputation + repChange));
            state.sanity = Math.max(0, state.sanity + sanityChange);
            state.postedToday = true;
            closePostModal();

            // Diminishing returns for spamming wild
            let fatigueMultiplier = 1.0;
            if(state.lastVibe === 'wild' && vibe === 'wild') {
                fatigueMultiplier = 0.5;
                log("Viewer Fatigue: Earnings halved from spamming Wild.", "text-orange-400");
            }
            state.lastVibe = vibe;

            const tierMult = 1 + (state.rankIdx * 0.5);
            // Agency Boost (Viral House)
            const agencyBoost = (state.agency === 'viral') ? 2.0 : 1.0;
            const upgradeBoost = (state.upgrades.mirrorless) ? 1.15 : 1.0;

            const finalMaxLikes = Math.floor(potentialLikes * tierMult * fatigueMultiplier * agencyBoost * upgradeBoost * (0.8 + Math.random() * 0.4));

            state.currentEarnings = 0;
            state.activePost = {
                mediaUrls: [...state.tempMediaUrls], // Copy array
                caption: caption,
                vibe: vibe,
                likes: 0,
                maxLikes: Math.max(1, finalMaxLikes),
                timestamp: `Day ${state.day}`,
                isPenalty: isPenalty
            };

            if(!isPenalty) {
                state.currentEarnings += AGE_DATA[player.ageRange].postBonus;
            }

            // Check Immediate Game Over conditions
            if(state.reputation <= 0) {
                setTimeout(() => triggerGameOver("CANCELLED", "Reputation Hit Zero"), 1000);
            }

            renderFeedStart();
        }

        function renderFeedStart() {
            document.getElementById('feed-empty').classList.add('hidden');
            document.getElementById('feed-archive').classList.add('hidden');
            document.getElementById('feed-active').classList.remove('hidden');
            document.getElementById('feed-active').classList.add('flex');
            
            // Render Carousel
            const container = document.getElementById('feed-media-container');
            container.innerHTML = "";
            state.activePost.mediaUrls.forEach(url => {
                const item = document.createElement('div');
                item.className = "carousel-item w-full h-full flex-shrink-0";
                item.innerHTML = `<img src="${url}" class="w-full h-full object-cover">`;
                container.appendChild(item);
            });
            
            // Badge Overlay
            const badge = document.createElement('div');
            badge.className = "absolute bottom-3 right-3 bg-black/60 backdrop-blur px-2 py-1 rounded text-[10px] text-white font-bold uppercase border border-white/20";
            badge.innerText = state.activePost.vibe.toUpperCase();
            container.appendChild(badge);
            
            setText('post-caption-display', state.activePost.caption || "...");
            setText('virality-badge', state.activePost.vibe.toUpperCase());
            setText('live-earnings', state.currentEarnings.toFixed(2));
            document.getElementById('comments-container').innerHTML = "";

            document.getElementById('btn-reply').classList.remove('hidden');

            clearInterval(liveInterval);
            liveInterval = setInterval(simulateLiveFeed, 100);
            log(`Published content.`, "text-zinc-400");
        }

        function simulateLiveFeed() {
            if(!state.activePost) return;
            if(state.activePost.likes >= state.activePost.maxLikes) return;

            state.activePost.likes++;
            setText('live-likes', state.activePost.likes);

            if(!state.activePost.isPenalty) {
                const ageData = AGE_DATA[player.ageRange];
                const rankBonus = RANKS[state.rankIdx].bonus;
                let perLike = BASE_LIKE_RATE + rankBonus + ageData.likeBonus;
                
                // Upgrades
                if(state.upgrades.camera) perLike += 2;
                if(state.upgrades.ringlight && Math.random() > 0.9) perLike += 5; // Tip chance

                state.currentEarnings += perLike;
                state.money += perLike;
            }
            
            setText('live-earnings', state.currentEarnings.toFixed(2));
            
            if(Math.random() > 0.8) addComment();
        }

        function addComment() {
            let pool = COMMENTS_SAFE;
            if(state.activePost.vibe === 'wild') pool = COMMENTS_WILD;
            else if(state.activePost.vibe === 'modest') pool = Math.random() > 0.5 ? COMMENTS_SAFE : COMMENTS_BAD;
            
            const txt = pool[Math.floor(Math.random() * pool.length)];
            const div = document.createElement('div');
            div.className = "pop-in flex gap-2 mb-2";
            div.innerHTML = `
                <div class="w-5 h-5 rounded-full bg-zinc-700 flex-shrink-0"></div>
                <div><span class="font-bold text-xs block text-zinc-500">fan_${Math.floor(Math.random()*999)}</span><span class="text-zinc-300 text-xs">${txt}</span></div>
            `;
            const c = document.getElementById('comments-container');
            if(c) {
                c.prepend(div);
                if(c.children.length > 5) c.lastChild.remove();
            }
        }

        function replyToComments() {
            if(state.energy < 10) return;
            state.energy -= 10;
            state.activePost.maxLikes += 15;
            const div = document.createElement('div');
            div.className = "pop-in flex gap-2 pl-4 border-l-2 border-blue-500 mb-2";
            div.innerHTML = `<div><span class="font-bold text-blue-400 text-xs">You</span><span class="text-white text-xs">Thanks luv! x</span></div>`;
            document.getElementById('comments-container').prepend(div);
            updateUI();
        }

        // --- SYSTEM ---
        function toggleArchive() {
            if(state.activePost) return alert("End current day first.");
            const archive = document.getElementById('feed-archive');
            const empty = document.getElementById('feed-empty');
            
            if(archive.classList.contains('hidden')) {
                empty.classList.add('hidden');
                archive.classList.remove('hidden');
                archive.classList.add('flex');
                renderArchive();
            } else {
                archive.classList.add('hidden');
                archive.classList.remove('flex');
                empty.classList.remove('hidden');
            }
        }

        function renderArchive() {
            const container = document.getElementById('archive-container');
            container.innerHTML = "";
            if(state.pastPosts.length === 0) container.innerHTML = "<div class='text-center text-zinc-600 text-sm py-10'>No history.</div>";
            
            state.pastPosts.slice().reverse().forEach(post => {
                const el = document.createElement('div');
                el.className = "bg-zinc-900 rounded p-2 flex gap-3 border border-zinc-800";
                
                // Show first image thumbnail
                const thumb = post.mediaUrls[0] || "";
                
                el.innerHTML = `
                    <img src="${thumb}" class="w-16 h-16 object-cover rounded bg-black">
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] text-zinc-500">${post.timestamp}</span>
                            <span class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-zinc-800 text-zinc-400">${post.vibe}</span>
                        </div>
                        <div class="text-xs text-white truncate w-32 mb-1">${post.caption}</div>
                        <div class="text-[10px] text-green-500 font-mono">+$${post.earned.toFixed(2)}</div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function endDay() {
            clearInterval(liveInterval);
            document.getElementById('btn-reply').classList.add('hidden');

            let grossToday = 0;
            let subsGained = 0;

            if(state.activePost) {
                grossToday = state.currentEarnings;
                state.activePost.earned = grossToday;
                state.pastPosts.push(state.activePost);
                
                subsGained = Math.floor(state.activePost.likes / 3);
                state.activePost = null;
            }

            state.subscribers += subsGained;
            log(`Day End. Gross: $${grossToday.toFixed(2)}`, "text-zinc-300");

            // --- TAX CALCULATION ---
            let taxRate = RANKS[state.rankIdx].tax;
            
            // Agency Logic
            let agencyRetainer = 0;
            if(state.agency) {
                const ag = AGENCIES[state.agency];
                taxRate = ag.tax; // Override standard tax
                agencyRetainer = ag.retainer;
                
                // Specific Agency Benefits
                if(state.agency === 'chatter') {
                    state.sanity = Math.min(100, state.sanity + 10);
                }
                
                log(`Agency Tax (${(taxRate*100).toFixed(0)}%): -$${(grossToday*taxRate).toFixed(2)}`, "text-purple-400");
            } else {
                log(`Platform Tax (${(taxRate*100).toFixed(0)}%): -$${(grossToday*taxRate).toFixed(2)}`, "text-red-400");
            }

            const taxAmount = grossToday * taxRate;
            state.money -= taxAmount;
            state.costs.lastTax = taxAmount;

            if(agencyRetainer > 0) {
                state.money -= agencyRetainer;
                log(`Agency Retainer: -$${agencyRetainer}`, "text-yellow-400");
            }

            // --- INFLATION & EXPENSES ---
            const inflationMultiplier = 1.05; // 5% Daily Increase
            state.costs.rent *= inflationMultiplier; 
            state.costs.living *= inflationMultiplier;
            
            const expenses = state.costs.rent + state.costs.living;
            state.money -= expenses;
            
            log(`Inflation +5%. Burn: -$${expenses.toFixed(2)}`, "text-orange-500 font-bold");

            // Random Events
            if(!state.upgrades.security && Math.random() > 0.85) {
                log("‚ö†Ô∏è CONTENT LEAK! Sanity dropped.", "text-red-500 font-bold");
                state.sanity -= 30;
                state.subscribers += 200; 
            }
            if(Math.random() > 0.90) { // Family found out
                log("üëÄ FAMILY FOUND OUT! Reputation tanked.", "text-red-500 font-bold");
                state.reputation -= 30;
            }
            if(Math.random() > 0.95) { // Phone Broke
                log("üì± PHONE BROKE! Emergency repair -$200.", "text-red-500 font-bold");
                state.money -= 200;
            }
            if(Math.random() > 0.95) { // Internet Out
                log("üåê INTERNET OUT! Data fees -$50.", "text-red-500 font-bold");
                state.money -= 50;
            }
            if(Math.random() > 0.98) { // Blackout
                log("‚ö° BLACKOUT! Energy drained.", "text-yellow-500 font-bold");
                state.energy = 0;
            }

            state.day++;
            if(state.energy < 100) state.energy = 100; // Restore energy on sleep unless blackout happened inside loop? No, sleep restores.
            
            state.postedToday = false;
            updateRank();

            if(state.money < -1000) { 
                triggerGameOver("BANKRUPT", "Debt Exceeded -$1000");
            } else if (state.reputation <= 0) {
                triggerGameOver("CANCELLED", "Reputation Hit Zero");
            } else {
                document.getElementById('feed-active').classList.add('hidden');
                document.getElementById('feed-archive').classList.add('hidden');
                document.getElementById('feed-empty').classList.remove('hidden');
                document.getElementById('feed-active').classList.remove('flex');
                updateUI();
            }
        }

        function triggerGameOver(title, reason) {
            setText('game-over-title', title);
            setText('game-over-msg', reason);
            setText('final-rank', RANKS[state.rankIdx].name);
            setText('final-subs', state.subscribers.toLocaleString());
            document.getElementById('game-over-modal').classList.remove('hidden');
        }

        function updateRank() {
            let idx = 0;
            // Check Studio requirement for Queen
            RANKS.forEach((r, i) => { 
                if(state.subscribers >= r.threshold) {
                    if (r.name === "QUEEN" && !state.upgrades.studio) return;
                    idx = i; 
                }
            });
            if(idx > state.rankIdx) {
                state.rankIdx = idx;
                log(`Rank Up: ${RANKS[idx].name}!`, "text-purple-400");
            }
        }

        function updateUI() {
            // Safe Updates
            setText('money-display', state.money.toFixed(2));
            const moneyWrapper = document.getElementById('money-display');
            if(moneyWrapper) moneyWrapper.className = state.money < 0 ? "text-red-500" : "text-green-500";
            
            setText('phone-balance', `$${state.money.toFixed(0)}`);
            const pBal = document.getElementById('phone-balance');
            if(pBal) pBal.className = state.money < 0 ? "font-mono text-sm font-bold text-red-500" : "font-mono text-sm font-bold text-green-500";

            setText('energy-val', `${state.energy}%`);
            const eBar = document.getElementById('energy-bar');
            if(eBar) eBar.style.width = `${state.energy}%`;

            // New Bars
            const repBar = document.getElementById('rep-bar');
            if(repBar) repBar.style.width = `${state.reputation}%`;
            
            const sanBar = document.getElementById('sanity-bar');
            if(sanBar) sanBar.style.width = `${state.sanity}%`;
            
            setText('subs-display', state.subscribers.toLocaleString());
            
            const r = RANKS[state.rankIdx];
            setText('tier-name', r.name);
            const tierEl = document.getElementById('tier-name');
            if(tierEl) tierEl.className = `text-4xl font-black tracking-tight ${r.color}`;
            
            let taxDisplay = r.tax;
            if(state.agency) taxDisplay = AGENCIES[state.agency].tax;

            setText('current-tax-rate', `${(taxDisplay * 100).toFixed(0)}%`);
            setText('rate-info-rank', `Rank Bonus: +$${r.bonus}`);
            
            const ageBonus = AGE_DATA[player.ageRange]?.likeBonus || 0;
            const totalRate = BASE_LIKE_RATE + r.bonus + ageBonus + (state.upgrades.camera ? 2 : 0);
            setText('phone-rate', `$${totalRate}/like`);

            // Costs
            setText('cost-rent', `-$${state.costs.rent.toFixed(2)}`);
            setText('cost-living', `-$${state.costs.living.toFixed(2)}`);
            
            if(state.costs.lastTax > 0) {
                document.getElementById('tax-container').classList.remove('hidden');
                setText('cost-tax', `-$${state.costs.lastTax.toFixed(2)}`);
            } else {
                document.getElementById('tax-container').classList.add('hidden');
            }

            const extraContainer = document.getElementById('extra-costs-container');
            if(extraContainer) {
                extraContainer.innerHTML = "";
                let extraTotal = 0;
                state.costs.extra.forEach(e => {
                    extraTotal += e.price;
                    extraContainer.innerHTML += `<div class="flex justify-between items-center text-zinc-500 text-xs"><span class="text-orange-400">${e.name}</span><span class="text-white font-mono">-$${e.price.toFixed(2)}</span></div>`;
                });
                
                let agencyFee = 0;
                if(state.agency) agencyFee = AGENCIES[state.agency].retainer;

                const total = state.costs.rent + state.costs.living + state.costs.lastTax + extraTotal + agencyFee;
                setText('total-daily-cost', `-$${total.toFixed(2)}`);
            }

            const btn = document.getElementById('btn-create-post');
            const msg = document.getElementById('post-limit-msg');
            
            if(btn && msg) {
                if(state.postedToday && !state.penaltyActive) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.disabled = true;
                    msg.classList.remove('hidden');
                } else {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.disabled = false;
                    msg.classList.add('hidden');
                }
            }
            
            // Agency Button Text
            const agBtn = document.getElementById('btn-agency');
            if(agBtn) {
                if(state.agency) {
                    agBtn.innerHTML = `<i data-lucide="check-circle" class="text-green-500 w-5 h-5"></i><span class="text-green-400 text-xs font-bold">Signed</span>`;
                } else {
                    agBtn.innerHTML = `<i data-lucide="briefcase" class="text-purple-500 w-5 h-5"></i><span class="text-zinc-300 text-xs font-bold">Agency</span>`;
                }
            }
            lucide.createIcons();
        }

        function log(msg, cls="text-zinc-400") {
            const div = document.createElement('div');
            div.className = `mb-1 ${cls}`;
            div.innerText = `> ${msg}`;
            const logEl = document.getElementById('game-log');
            if(logEl) logEl.prepend(div);
        }
    </script>
</body>
</html>
